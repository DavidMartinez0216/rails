require 'rake/testtask'

task :default => :test

task :package

desc "Run all unit tests"
task :test => 'test:isolated'

namespace :test do
  task :isolated do
    dirs = (ENV["TEST_DIR"] || ENV["TEST_DIRS"] || "**").split(",")
    test_files = dirs.map { |dir| "test/#{dir}/*_test.rb" }
    test_files = Dir[*test_files]
    test_files.reject!{|f|
      f.include?("fixtures")
    }

    dash_i = [
      'test',
      'lib',
      "#{File.dirname(__FILE__)}/../activesupport/lib",
      "#{File.dirname(__FILE__)}/../actionpack/lib",
      "#{File.dirname(__FILE__)}/../activemodel/lib",
    ]

    if Process.respond_to?(:fork)
      require "#{File.dirname(__FILE__)}../../load_paths"

      dash_i.each do |path|
        $LOAD_PATH << path
      end

      test_files.each do |file|
        Process.wait(Process.fork {
          puts "Running #{file}"
          require "./#{file}"
        })
        exit $?.exitstatus if $?.exitstatus != 0
      end
    else
      test_files.each do |file|
        ruby "-w", "-I#{dash_i.join ':'}", file
      end
    end
  end
end

Rake::TestTask.new('test:regular') do |t|
  t.libs << 'test' << "#{File.dirname(__FILE__)}/../activesupport/lib"
  t.pattern = 'test/**/*_test.rb'
  t.warning = false
  t.verbose = true
  t.ruby_opts = ["--dev"] if defined?(JRUBY_VERSION)
end
